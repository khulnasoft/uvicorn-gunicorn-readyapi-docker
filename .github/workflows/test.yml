name: Test

on:
  push:
    branches:
      - master
  pull_request:
    types:
      - opened
      - synchronize
  workflow_dispatch:
  schedule:
    # cron every week on monday
    - cron: "0 0 * * 1"

env:
  DOCKER_BUILDKIT: 1

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'khulnasoft/uvicorn-gunicorn:python3.11'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run pre-commit checks
        uses: pre-commit/action@v4
      - name: Run mypy
        run: mypy tests/
      - name: Run pytest with coverage
        run: |
          pytest --cov=tests --cov-report=xml --cov-report=term-missing
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

  test:
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: python3.11
            python_version: "3.11"
          - name: python3.10
            python_version: "3.10"
          - name: python3.9
            python_version: "3.9"
          - name: python3.11-slim
            python_version: "3.11"
          - name: python3.10-slim
            python_version: "3.10"
          - name: python3.9-slim
            python_version: "3.9"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set Dockerfile name
        run: echo "DOCKERFILE_NAME=${{ matrix.image.name }}" >> $GITHUB_ENV
      - name: Build image
        uses: docker/build-push-action@v4
        with:
          push: false
          tags: khulnasoft/uvicorn-gunicorn-readyapi:${{ matrix.image.name }}
          context: ./docker-images/
          file: ./docker-images/${{ env.DOCKERFILE_NAME }}.dockerfile
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      - name: Test basic functionality
        run: pytest tests/test_01_main/ -v
        env:
          NAME: ${{ matrix.image.name }}
          PYTHON_VERSION: ${{ matrix.image.python_version }}
      - name: Test security features
        run: pytest tests/test_02_security/ -v
        env:
          NAME: ${{ matrix.image.name }}
          PYTHON_VERSION: ${{ matrix.image.python_version }}
        if: matrix.image.name != 'python3.8' && matrix.image.name != 'python3.7'

  integration-test:
    needs: [test, code-quality]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      - name: Run integration tests
        run: pytest tests/ -v -m integration
        env:
          NAME: python3.11
          PYTHON_VERSION: "3.11"

  check:
    if: always()
    needs:
      - security-scan
      - code-quality
      - test
      - integration-test
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
